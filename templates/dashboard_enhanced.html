<!DOCTYPE html>
<html>
<head>
    <title>Saudi eVisa Automation Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .value { font-size: 36px; color: #2196F3; font-weight: bold; }
        .controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button { background: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        button:hover { background: #1976D2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-orange { background: #FF9800; } .btn-orange:hover { background: #F57C00; }
        .btn-green { background: #4CAF50; } .btn-green:hover { background: #388E3C; }
        .btn-red { background: #f44336; } .btn-red:hover { background: #d32f2f; }
        .btn-purple { background: #9C27B0; } .btn-purple:hover { background: #7B1FA2; }
        .btn-gray { background: #666; } .btn-gray:hover { background: #555; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .progress-bar { display: none; margin-top: 15px; }
        .progress-container { background: #e0e0e0; border-radius: 4px; height: 30px; position: relative; }
        .progress-fill { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 13px; font-weight: bold; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; border-radius: 8px 8px 0 0; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab.active { background: #2196F3; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .search-bar input { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .search-bar select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #2196F3; color: white; padding: 12px 8px; text-align: left; position: sticky; top: 0; cursor: pointer; user-select: none; }
        th:hover { background: #1976D2; }
        th .sort-icon { margin-left: 5px; font-size: 10px; }
        td { padding: 10px 8px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f5f5f5; }
        tr.selected { background: #e3f2fd; }
        .table-wrapper { max-height: 600px; overflow-y: auto; }
        .no-data { text-align: center; padding: 40px; color: #999; }
        .config-section { margin-top: 20px; display: none; }
        .config-section input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .config-section label { display: block; margin-top: 10px; font-weight: bold; }
        .alert { padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .alert-info { background: #e3f2fd; border-left: 4px solid #2196F3; }
        .alert-success { background: #e8f5e9; border-left: 4px solid #4CAF50; }
        .alert-warning { background: #fff3e0; border-left: 4px solid #FF9800; }
        .pagination { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; padding: 15px; background: white; border-radius: 4px; }
        .pagination button { margin: 0; }
        .pagination span { font-weight: bold; color: #333; }
        .pagination select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .chart-container h3 { margin-bottom: 15px; color: #333; font-size: 16px; }
        .chart-wrapper { position: relative; height: 350px; }
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .analysis-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .analysis-card h3 { color: #2196F3; margin-bottom: 15px; font-size: 18px; }
        .metric { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: #666; font-size: 14px; }
        .metric-value { color: #333; font-weight: bold; font-size: 16px; }
        .trend-up { color: #4CAF50; }
        .trend-down { color: #f44336; }
        .top-list { list-style: none; }
        .top-list li { padding: 10px; margin: 5px 0; background: #f9f9f9; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .top-list .rank { background: #2196F3; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; flex-shrink: 0; }
        .top-list .name { flex: 1; }
        .top-list .count { font-weight: bold; color: #2196F3; }
        .selection-toolbar { background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 10px; display: none; align-items: center; gap: 10px; }
        .selection-toolbar span { font-weight: bold; color: #2196F3; }
        input[type="checkbox"] { cursor: pointer; width: 18px; height: 18px; }
        .audio-status { position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; z-index: 1000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .audio-status.speaking { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üá∏üá¶ Saudi eVisa Automation Dashboard</h1>
        
        <div id="alertContainer"></div>
        <div id="audioStatus" class="audio-status">üîä Speaking...</div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Total Records</h3>
                <div class="value" id="totalProcessed">0</div>
            </div>
            <div class="stat-card">
                <h3>Unique Employers</h3>
                <div class="value" id="employerCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Nationalities</h3>
                <div class="value" id="nationalityCount">0</div>
            </div>
            <div class="stat-card">
                <h3>This Month</h3>
                <div class="value" id="monthCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Auto-Monitor</h3>
                <div class="value" id="monitorStatus" style="font-size: 24px;">üîî ON</div>
            </div>
        </div>
        
        <div class="controls">
            <div>
                <button onclick="processEmails(false)" id="processBtn">üìß Process New Emails</button>
                <button onclick="processEmails(true)" id="processAllBtn" class="btn-orange">üîÑ Process All</button>
                <button onclick="scanAndExtract()" id="scanBtn" class="btn-green">üìÇ Scan & Extract PDFs</button>
                <button onclick="retryExtraction()" id="retryBtn" class="btn-red">üîÑ Retry Extraction</button>
                <button onclick="openMainFolder()" class="btn-orange">üìÅ Open Folder</button>
                <button onclick="toggleAutoMonitor()" id="autoMonitorBtn" class="btn-red">üîï Stop Auto-Monitor</button>
                <button onclick="toggleConfig()" class="btn-gray">‚öôÔ∏è Configure</button>
                <button onclick="refreshData()" class="btn-green">üîÑ Refresh</button>
            </div>
            
            <div id="progressBar" class="progress-bar">
                <div class="progress-container">
                    <div id="progressFill" class="progress-fill"></div>
                    <div id="progressText" class="progress-text">0%</div>
                </div>
            </div>
            
            <div id="configSection" class="config-section">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Important:</strong> Use Gmail App Password!<br>
                    <small>Generate at: <a href="https://myaccount.google.com/apppasswords" target="_blank">myaccount.google.com/apppasswords</a></small>
                </div>
                <label>Email:</label>
                <input type="text" id="email" placeholder="your-email@gmail.com">
                <label>App Password:</label>
                <input type="password" id="password" placeholder="xxxx xxxx xxxx xxxx">
                <label>From Email:</label>
                <input type="text" id="fromEmail" placeholder="no-reply@mofa.gov.sa">
                <label>Subject Filter:</label>
                <input type="text" id="subjectFilter" placeholder="Saudi eVisa">
                <label>Save Path:</label>
                <input type="text" id="savePath" placeholder="\\\\COUNTER3\\Shared Data\\Visa_Slips_Automated">
                <label>Auto-Monitor Interval (seconds):</label>
                <input type="number" id="checkInterval" value="300" min="60">
                <label>
                    <input type="checkbox" id="audioEnabled" checked> Enable Audio Announcements
                </label>
                <button onclick="saveConfig()" style="margin-top: 10px;">üíæ Save Configuration</button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">üìä Overview</div>
            <div class="tab" onclick="switchTab('analytics')">üìà Analytics</div>
            <div class="tab" onclick="switchTab('records')">üìã All Records</div>
            <div class="tab" onclick="switchTab('recent')">üÜï Recent</div>
            <div class="tab" onclick="switchTab('employers')">üè¢ Employers</div>
            <div class="tab" onclick="switchTab('dates')">üìÖ Dates</div>
        </div>

        <div id="overview" class="tab-content active">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìã Activity Log</h3>
                <div id="logContainer" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <div class="chart-grid">
                <div class="chart-container">
                    <h3>üìä Visas by Nationality</h3>
                    <div class="chart-wrapper">
                        <canvas id="nationalityChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìà Visas Over Time</h3>
                    <div class="chart-wrapper">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üè¢ Top 10 Employers</h3>
                    <div class="chart-wrapper">
                        <canvas id="employerChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üíº Occupations Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="occupationChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìÖ Visa Types</h3>
                    <div class="chart-wrapper">
                        <canvas id="visaTypeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>‚è±Ô∏è Processing Duration</h3>
                    <div class="chart-wrapper">
                        <canvas id="durationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3>üìä Key Metrics</h3>
                    <div class="metric">
                        <span class="metric-label">Total Visas</span>
                        <span class="metric-value" id="metricTotal">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg per Day</span>
                        <span class="metric-value" id="metricAvgPerDay">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Most Active Day</span>
                        <span class="metric-value" id="metricMostActiveDay">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Common Visa Type</span>
                        <span class="metric-value" id="metricCommonVisaType">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Avg Duration</span>
                        <span class="metric-value" id="metricAvgDuration">0 days</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <h3>üèÜ Top 5 Nationalities</h3>
                    <ul class="top-list" id="topNationalities"></ul>
                </div>

                <div class="analysis-card">
                    <h3>üè¢ Top 5 Employers</h3>
                    <ul class="top-list" id="topEmployers"></ul>
                </div>

                <div class="analysis-card">
                    <h3>üíº Top 5 Occupations</h3>
                    <ul class="top-list" id="topOccupations"></ul>
                </div>

                <div class="analysis-card">
                    <h3>üìÖ Recent Trends</h3>
                    <div class="metric">
                        <span class="metric-label">This Month</span>
                        <span class="metric-value trend-up" id="trendThisMonth">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last 7 Days</span>
                        <span class="metric-value" id="trendLast7Days">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last 30 Days</span>
                        <span class="metric-value" id="trendLast30Days">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Growth Rate</span>
                        <span class="metric-value trend-up" id="trendGrowthRate">0%</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <h3>üåç Geographic</h3>
                    <div class="metric">
                        <span class="metric-label">Total Countries</span>
                        <span class="metric-value" id="geoTotalCountries">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Most Common</span>
                        <span class="metric-value" id="geoMostCommonRegion">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Asian Countries</span>
                        <span class="metric-value" id="geoAsianCount">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Other Regions</span>
                        <span class="metric-value" id="geoOtherCount">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="records" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìã All Visa Records</h3>
                
                <div id="selectionToolbar" class="selection-toolbar">
                    <span id="selectedCount">0 selected</span>
                    <button onclick="exportSelectedToExcel()" class="btn-green btn-small">üì• Export Selected to Excel</button>
                    <button onclick="clearSelection()" class="btn-gray btn-small">‚úñ Clear Selection</button>
                </div>
                
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search..." onkeyup="searchRecords()">
                    <select id="filterNationality" onchange="applyFilters()">
                        <option value="">All Nationalities</option>
                    </select>
                    <select id="filterEmployer" onchange="applyFilters()">
                        <option value="">All Employers</option>
                    </select>
                    <select id="filterVisaType" onchange="applyFilters()">
                        <option value="">All Visa Types</option>
                    </select>
                    <button onclick="exportToCSV()">üì• Export CSV</button>
                    <button onclick="exportAllToExcel()" class="btn-green">üì• Export All to Excel</button>
                </div>
                
                <div class="table-wrapper">
                    <table id="recordsTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th onclick="sortTable('visa_no')">Visa No <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('name')">Name <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('passport_no')">Passport <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('nationality')">Nationality <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('visa_type')">Visa Type <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('valid_from')">Valid From <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('valid_until')">Valid Until <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('duration_of_stay')">Duration <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('occupation')">Occupation <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('employer_name')">Employer <span class="sort-icon">‚áÖ</span></th>
                                <th onclick="sortTable('processed_date')">Date <span class="sort-icon">‚áÖ</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                            <tr><td colspan="13" class="no-data">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="paginationControls" style="display: none;">
                    <button onclick="changePage(1)" id="firstPage">‚èÆ First</button>
                    <button onclick="changePage(currentPage - 1)" id="prevPage">‚óÄ Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button onclick="changePage(currentPage + 1)" id="nextPage">Next ‚ñ∂</button>
                    <button onclick="changePage(totalPages)" id="lastPage">Last ‚è≠</button>
                    <select id="perPageSelect" onchange="changePerPage()">
                        <option value="25">25 per page</option>
                        <option value="50" selected>50 per page</option>
                        <option value="100">100 per page</option>
                        <option value="200">200 per page</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="recent" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üÜï Recent Records (Last 50)</h3>
                <div id="recentRecordsContainer"></div>
            </div>
        </div>

        <div id="employers" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üè¢ Records by Employer</h3>
                <div id="employersContainer"></div>
            </div>
        </div>

        <div id="dates" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìÖ Records by Date</h3>
                <div id="datesContainer"></div>
            </div>
        </div>
    </div>

    <script>
