<!DOCTYPE html>
<html>
<head>
    <title>Saudi eVisa Automation Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .value { font-size: 36px; color: #2196F3; font-weight: bold; }
        .controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button { background: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        button:hover { background: #1976D2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-orange { background: #FF9800; } .btn-orange:hover { background: #F57C00; }
        .btn-green { background: #4CAF50; } .btn-green:hover { background: #388E3C; }
        .btn-gray { background: #666; } .btn-gray:hover { background: #555; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .progress-bar { display: none; margin-top: 15px; }
        .progress-container { background: #e0e0e0; border-radius: 4px; height: 30px; position: relative; }
        .progress-fill { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 13px; font-weight: bold; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; border-radius: 8px 8px 0 0; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab.active { background: #2196F3; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-bar input { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #2196F3; color: white; padding: 12px 8px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px 8px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f5f5f5; }
        .table-wrapper { max-height: 600px; overflow-y: auto; }
        .no-data { text-align: center; padding: 40px; color: #999; }
        .config-section { margin-top: 20px; display: none; }
        .config-section input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .config-section label { display: block; margin-top: 10px; font-weight: bold; }
        .alert { padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .alert-info { background: #e3f2fd; border-left: 4px solid #2196F3; }
        .alert-success { background: #e8f5e9; border-left: 4px solid #4CAF50; }
        .alert-warning { background: #fff3e0; border-left: 4px solid #FF9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üá∏üá¶ Saudi eVisa Automation Dashboard</h1>
        
        <div id="alertContainer"></div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Total Records</h3>
                <div class="value" id="totalProcessed">{{ stats.total_processed }}</div>
            </div>
            <div class="stat-card">
                <h3>Unique Employers</h3>
                <div class="value" id="employerCount">{{ stats.by_employer|length }}</div>
            </div>
            <div class="stat-card">
                <h3>Nationalities</h3>
                <div class="value" id="nationalityCount">{{ stats.by_nationality|length }}</div>
            </div>
            <div class="stat-card">
                <h3>This Month</h3>
                <div class="value" id="monthCount">0</div>
            </div>
        </div>
        
        <div class="controls">
            <div>
                <button onclick="processEmails(false)" id="processBtn">üìß Process New Emails</button>
                <button onclick="processEmails(true)" id="processAllBtn" class="btn-orange">üîÑ Process All</button>
                <button onclick="scanAndExtract()" id="scanBtn" class="btn-green">üìÇ Scan & Extract Existing PDFs</button>
                <button onclick="openMainFolder()" class="btn-orange">üìÅ Open Folder</button>
                <button onclick="toggleAutoMonitor()" id="autoMonitorBtn" class="btn-green">üîî Start Auto-Monitor</button>
                <button onclick="toggleConfig()" class="btn-gray">‚öôÔ∏è Configure</button>
                <button onclick="refreshData()" class="btn-green">üîÑ Refresh Data</button>
            </div>
            
            <div id="progressBar" class="progress-bar">
                <div class="progress-container">
                    <div id="progressFill" class="progress-fill"></div>
                    <div id="progressText" class="progress-text">0%</div>
                </div>
            </div>
            
            <div id="configSection" class="config-section">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Important:</strong> Use Gmail App Password, not regular password!<br>
                    <small>Generate at: <a href="https://myaccount.google.com/apppasswords" target="_blank">myaccount.google.com/apppasswords</a></small>
                </div>
                <label>Email:</label>
                <input type="text" id="email" placeholder="your-email@gmail.com">
                <label>App Password:</label>
                <input type="password" id="password" placeholder="xxxx xxxx xxxx xxxx">
                <label>From Email:</label>
                <input type="text" id="fromEmail" placeholder="no-reply@mofa.gov.sa">
                <label>Subject Filter:</label>
                <input type="text" id="subjectFilter" placeholder="Saudi eVisa">
                <label>Save Path:</label>
                <input type="text" id="savePath" placeholder="\\COUNTER3\Shared Data\Visa_Slips_Automated">
                <label>Auto-Monitor Interval (seconds):</label>
                <input type="number" id="checkInterval" value="300" min="60">
                <button onclick="saveConfig()" style="margin-top: 10px;">üíæ Save Configuration</button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">üìä Overview</div>
            <div class="tab" onclick="switchTab('records')">üìã All Records</div>
            <div class="tab" onclick="switchTab('recent')">üÜï Recent</div>
            <div class="tab" onclick="switchTab('employers')">üè¢ By Employer</div>
            <div class="tab" onclick="switchTab('dates')">üìÖ By Date</div>
        </div>

        <div id="overview" class="tab-content active">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìã Activity Log</h3>
                <div id="logContainer" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="records" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìã All Visa Records</h3>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by name, visa no, passport, employer..." onkeyup="searchRecords()">
                    <button onclick="exportToCSV()">üì• Export CSV</button>
                </div>
                <div class="table-wrapper">
                    <table id="recordsTable">
                        <thead>
                            <tr>
                                <th>Visa No</th>
                                <th>Name</th>
                                <th>Passport</th>
                                <th>Nationality</th>
                                <th>Employer</th>
                                <th>Valid From</th>
                                <th>Valid Until</th>
                                <th>Duration</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                            <tr><td colspan="10" class="no-data">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="recent" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üÜï Recent Records (Last 50)</h3>
                <div id="recentRecordsContainer"></div>
            </div>
        </div>

        <div id="employers" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üè¢ Records by Employer</h3>
                <div id="employersContainer"></div>
            </div>
        </div>

        <div id="dates" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìÖ Records by Date</h3>
                <div id="datesContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let config = {};
        let allRecords = [];
        let autoMonitorInterval = null;
        
        // Load configuration
        async function loadConfig() {
            const response = await fetch('/api/config');
            config = await response.json();
            document.getElementById('email').value = config.email || '';
            document.getElementById('password').value = config.password || '';
            document.getElementById('fromEmail').value = config.from_email || '';
            document.getElementById('subjectFilter').value = config.subject_filter || '';
            document.getElementById('savePath').value = config.save_path || '';
            document.getElementById('checkInterval').value = config.check_interval || 300;
        }
        
        // Save configuration
        async function saveConfig() {
            const newConfig = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                from_email: document.getElementById('fromEmail').value,
                subject_filter: document.getElementById('subjectFilter').value,
                save_path: document.getElementById('savePath').value,
                check_interval: parseInt(document.getElementById('checkInterval').value)
            };
            
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newConfig)
            });
            
            if (response.ok) {
                showAlert('Configuration saved successfully!', 'success');
                config = newConfig;
            }
        }
        
        function toggleConfig() {
            const section = document.getElementById('configSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }
        
        // Process emails
        async function processEmails(includeDownloaded = false) {
            const btn = document.getElementById('processBtn');
            const btnAll = document.getElementById('processAllBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            btn.disabled = true;
            btnAll.disabled = true;
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Starting...';
            
            addLog('üöÄ Starting email processing...');
            
            await processStream('/api/process', {include_downloaded: includeDownloaded}, btn, btnAll, progressBar, progressFill, progressText);
        }
        
        // Scan and extract existing PDFs
        async function scanAndExtract() {
            const btn = document.getElementById('scanBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (!confirm('This will scan all folders and extract data from unprocessed PDFs. PDFs will be renamed with "_extracted" suffix. Continue?')) {
                return;
            }
            
            btn.disabled = true;
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Scanning...';
            
            addLog('üîç Starting folder scan and extraction...');
            
            await processStream('/api/scan-and-extract', {}, btn, null, progressBar, progressFill, progressText);
        }
        
        // Generic stream processor
        async function processStream(url, body, btn1, btn2, progressBar, progressFill, progressText) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.type === 'progress') {
                                    const percent = (data.current / data.total * 100).toFixed(0);
                                    progressFill.style.width = percent + '%';
                                    progressText.textContent = `${data.current}/${data.total} (${percent}%)`;
                                } else if (data.type === 'info') {
                                    addLog(data.message, 'info');
                                } else if (data.type === 'success') {
                                    addLog(data.message, 'success');
                                } else if (data.type === 'warning') {
                                    addLog(data.message, 'warning');
                                } else if (data.type === 'error') {
                                    addLog(data.message, 'error');
                                } else if (data.type === 'summary') {
                                    const msg = data.total_scanned 
                                        ? `‚úÖ Processed: ${data.total_processed}/${data.total_scanned} PDFs`
                                        : `‚úÖ Total processed: ${data.total_processed} new records`;
                                    addLog(msg, 'success');
                                    if (data.total_processed > 0) {
                                        showAlert(`Successfully processed ${data.total_processed} records!`, 'success');
                                    }
                                } else if (data.type === 'complete') {
                                    addLog(data.message, 'success');
                                    progressFill.style.width = '100%';
                                    progressText.textContent = 'Complete!';
                                }
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }
                
                await refreshData();
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
            }
            
            btn1.disabled = false;
            if (btn2) btn2.disabled = false;
            setTimeout(() => {
                progressBar.style.display = 'none';
            }, 3000);
        }
        
        // Auto-monitor
        function toggleAutoMonitor() {
            const btn = document.getElementById('autoMonitorBtn');
            if (autoMonitorInterval) {
                clearInterval(autoMonitorInterval);
                autoMonitorInterval = null;
                btn.textContent = 'üîî Start Auto-Monitor';
                btn.className = 'btn-green';
                showAlert('Auto-monitor stopped', 'info');
            } else {
                const interval = (config.check_interval || 300) * 1000;
                autoMonitorInterval = setInterval(() => {
                    addLog('üîî Auto-monitor: Checking for new emails...', 'info');
                    processEmails(false);
                }, interval);
                btn.textContent = 'üîï Stop Auto-Monitor';
                btn.className = 'btn-orange';
                showAlert(`Auto-monitor started (checking every ${config.check_interval || 300} seconds)`, 'success');
            }
        }
        
        // Update statistics
        async function updateStats() {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            document.getElementById('totalProcessed').textContent = stats.total_processed;
            document.getElementById('employerCount').textContent = Object.keys(stats.by_employer).length;
            document.getElementById('nationalityCount').textContent = Object.keys(stats.by_nationality).length;
            
            // Calculate this month
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            let monthCount = 0;
            for (const [date, count] of Object.entries(stats.by_date)) {
                if (date.startsWith(thisMonth)) {
                    monthCount += count;
                }
            }
            document.getElementById('monthCount').textContent = monthCount;
        }
        
        // Load all records
        async function loadRecords() {
            const response = await fetch('/api/records');
            allRecords = await response.json();
            displayRecords(allRecords);
            displayRecentRecords();
            displayEmployers();
            displayDates();
        }
        
        // Display records in table
        function displayRecords(records) {
            const tbody = document.getElementById('recordsBody');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">No records found</td></tr>';
                return;
            }
            
            tbody.innerHTML = records.map(r => `
                <tr>
                    <td>${r.visa_no || 'N/A'}</td>
                    <td>${r.name || 'N/A'}</td>
                    <td>${r.passport_no || 'N/A'}</td>
                    <td>${r.nationality || 'N/A'}</td>
                    <td>${r.employer_name || 'N/A'}</td>
                    <td>${r.valid_from || 'N/A'}</td>
                    <td>${r.valid_until || 'N/A'}</td>
                    <td>${r.duration_of_stay || 'N/A'}</td>
                    <td>${r.processed_date || 'N/A'}</td>
                    <td>
                        <button class="btn-small btn-orange" onclick="openRecordFolder('${r.processed_date}', '${r.pdf_filename}')">üìÅ</button>
                        <button class="btn-small btn-green" onclick="openRecordFile('${r.processed_date}', '${r.pdf_filename}', 'xlsx')">üìä</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Search records
        function searchRecords() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) {
                displayRecords(allRecords);
                return;
            }
            
            const filtered = allRecords.filter(r => 
                (r.visa_no && r.visa_no.toLowerCase().includes(query)) ||
                (r.name && r.name.toLowerCase().includes(query)) ||
                (r.passport_no && r.passport_no.toLowerCase().includes(query)) ||
                (r.employer_name && r.employer_name.toLowerCase().includes(query)) ||
                (r.nationality && r.nationality.toLowerCase().includes(query))
            );
            displayRecords(filtered);
        }
        
        // Display recent records
        function displayRecentRecords() {
            const container = document.getElementById('recentRecordsContainer');
            const recent = allRecords.slice(0, 50);
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="no-data">No records yet</div>';
                return;
            }
            
            container.innerHTML = recent.map(r => `
                <div style="background: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid #4CAF50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #2196F3; font-size: 16px;">${r.name || 'N/A'}</strong>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                Visa: ${r.visa_no || 'N/A'} | Passport: ${r.passport_no || 'N/A'} | ${r.nationality || 'N/A'}
                            </div>
                            <div style="font-size: 13px; color: #666;">
                                Employer: ${r.employer_name || 'N/A'}
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 3px;">
                                Valid: ${r.valid_from || 'N/A'} to ${r.valid_until || 'N/A'} | Processed: ${r.processed_date || 'N/A'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn-small btn-orange" onclick="openRecordFolder('${r.processed_date}', '${r.pdf_filename}')">üìÅ Folder</button>
                            <button class="btn-small" onclick="openRecordFile('${r.processed_date}', '${r.pdf_filename}', 'pdf')">üìÑ PDF</button>
                            <button class="btn-small btn-green" onclick="openRecordFile('${r.processed_date}', '${r.pdf_filename}', 'xlsx')">üìä Excel</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Display employers
        function displayEmployers() {
            const container = document.getElementById('employersContainer');
            const employers = {};
            
            allRecords.forEach(r => {
                const emp = r.employer_name || 'Unknown';
                if (!employers[emp]) {
                    employers[emp] = [];
                }
                employers[emp].push(r);
            });
            
            const sorted = Object.entries(employers).sort((a, b) => b[1].length - a[1].length);
            
            container.innerHTML = sorted.map(([emp, records]) => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 16px;">${emp}</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                ${records.length} visa(s)
                            </div>
                        </div>
                        <button class="btn-small" onclick="filterByEmployer('${emp}')">View Records</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Display dates
        function displayDates() {
            const container = document.getElementById('datesContainer');
            const dates = {};
            
            allRecords.forEach(r => {
                const date = r.processed_date || 'Unknown';
                if (!dates[date]) {
                    dates[date] = [];
                }
                dates[date].push(r);
            });
            
            const sorted = Object.entries(dates).sort((a, b) => b[0].localeCompare(a[0]));
            
            container.innerHTML = sorted.map(([date, records]) => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 16px;">üìÖ ${date}</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                ${records.length} visa(s)
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-small btn-orange" onclick="openDateFolder('${date}')">üìÅ Open Folder</button>
                            <button class="btn-small" onclick="filterByDate('${date}')">View Records</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Filter functions
        function filterByEmployer(employer) {
            switchTab('records');
            document.getElementById('searchInput').value = employer;
            searchRecords();
        }
        
        function filterByDate(date) {
            switchTab('records');
            const filtered = allRecords.filter(r => r.processed_date === date);
            displayRecords(filtered);
        }
        
        // Open folder/file functions
        async function openMainFolder() {
            await openFolder(config.save_path);
        }
        
        async function openDateFolder(date) {
            const path = `${config.save_path}\\\\${date}`;
            await openFolder(path);
        }
        
        async function openRecordFolder(date, filename) {
            const path = `${config.save_path}\\\\${date}`;
            await openFolder(path);
        }
        
        async function openRecordFile(date, filename, ext) {
            const newFilename = filename.replace('.pdf', `.${ext}`);
            const path = `${config.save_path}\\\\${date}\\\\${newFilename}`;
            await openFolder(path);
        }
        
        async function openFolder(path) {
            try {
                const response = await fetch('/api/open-folder', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path: path})
                });
                const data = await response.json();
                if (!data.success) {
                    showAlert('Could not open: ' + data.error, 'warning');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        // Export to CSV
        function exportToCSV() {
            const headers = ['Visa No', 'Name', 'Passport', 'Nationality', 'Employer', 'Valid From', 'Valid Until', 'Duration', 'Date'];
            const rows = allRecords.map(r => [
                r.visa_no, r.name, r.passport_no, r.nationality, r.employer_name,
                r.valid_from, r.valid_until, r.duration_of_stay, r.processed_date
            ]);
            
            let csv = headers.join(',') + '\\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell || ''}"`).join(',') + '\\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `visa_records_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        // Refresh all data
        async function refreshData() {
            await updateStats();
            await loadRecords();
            showAlert('Data refreshed!', 'info');
        }
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // Logging
        function addLog(message, type = 'info') {
            const log = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.style.padding = '8px';
            entry.style.borderBottom = '1px solid #eee';
            entry.style.fontSize = '14px';
            entry.style.color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#FF9800' : '#2196F3';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.insertBefore(entry, log.firstChild);
            
            while (log.children.length > 100) {
                log.removeChild(log.lastChild);
            }
        }
        
        // Show alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Initialize
        loadConfig();
        updateStats();
        loadRecords();
        setInterval(updateStats, 30000);
        
        // Check for new emails every 5 minutes if auto-monitor is enabled
        setInterval(() => {
            if (autoMonitorInterval) {
                addLog('üîî Checking for new emails...', 'info');
            }
        }, 300000);
    </script>
</body>
</html>
