<!DOCTYPE html>
<html>
<head>
    <title>Saudi eVisa Automation Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .value { font-size: 36px; color: #2196F3; font-weight: bold; }
        .controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button { background: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        button:hover { background: #1976D2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-orange { background: #FF9800; } .btn-orange:hover { background: #F57C00; }
        .btn-green { background: #4CAF50; } .btn-green:hover { background: #388E3C; }
        .btn-gray { background: #666; } .btn-gray:hover { background: #555; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .progress-bar { display: none; margin-top: 15px; }
        .progress-container { background: #e0e0e0; border-radius: 4px; height: 30px; position: relative; }
        .progress-fill { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 13px; font-weight: bold; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; border-radius: 8px 8px 0 0; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab.active { background: #2196F3; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-bar input { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #2196F3; color: white; padding: 12px 8px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px 8px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f5f5f5; }
        .table-wrapper { max-height: 600px; overflow-y: auto; }
        .no-data { text-align: center; padding: 40px; color: #999; }
        .config-section { margin-top: 20px; display: none; }
        .config-section input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .config-section label { display: block; margin-top: 10px; font-weight: bold; }
        .alert { padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .alert-info { background: #e3f2fd; border-left: 4px solid #2196F3; }
        .alert-success { background: #e8f5e9; border-left: 4px solid #4CAF50; }
        .alert-warning { background: #fff3e0; border-left: 4px solid #FF9800; }
        .pagination { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; padding: 15px; background: white; border-radius: 4px; }
        .pagination button { margin: 0; }
        .pagination span { font-weight: bold; color: #333; }
        .pagination select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .chart-container h3 { margin-bottom: 15px; color: #333; font-size: 16px; }
        .chart-wrapper { position: relative; height: 300px; }
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .analysis-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .analysis-card h3 { color: #2196F3; margin-bottom: 15px; font-size: 18px; }
        .metric { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: #666; font-size: 14px; }
        .metric-value { color: #333; font-weight: bold; font-size: 16px; }
        .trend-up { color: #4CAF50; }
        .trend-down { color: #f44336; }
        .top-list { list-style: none; }
        .top-list li { padding: 10px; margin: 5px 0; background: #f9f9f9; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .top-list .rank { background: #2196F3; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
        .top-list .name { flex: 1; }
        .top-list .count { font-weight: bold; color: #2196F3; }
        footer { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; margin-top: 50px; border-radius: 8px 8px 0 0; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); }
        footer .footer-content { max-width: 1600px; margin: 0 auto; text-align: center; }
        footer .footer-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        footer .footer-title i { font-size: 24px; }
        footer .footer-info { font-size: 14px; margin-top: 10px; line-height: 1.8; }
        footer .footer-info strong { color: #FFD700; }
        footer a { color: #FFD700; text-decoration: none; transition: all 0.3s; }
        footer a:hover { color: #FFF; text-decoration: underline; }
        footer .footer-divider { margin: 15px auto; width: 80%; height: 1px; background: rgba(255,255,255,0.3); }
        footer .footer-icons { display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        footer .footer-icon-item { display: flex; align-items: center; gap: 5px; }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container">
        <h1>üá∏üá¶ Saudi eVisa Automation Dashboard</h1>
        
        <div id="alertContainer"></div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Total Records</h3>
                <div class="value" id="totalProcessed">{{ stats.total_processed }}</div>
            </div>
            <div class="stat-card">
                <h3>Unique Employers</h3>
                <div class="value" id="employerCount">{{ stats.by_employer|length }}</div>
            </div>
            <div class="stat-card">
                <h3>Nationalities</h3>
                <div class="value" id="nationalityCount">{{ stats.by_nationality|length }}</div>
            </div>
            <div class="stat-card">
                <h3>This Month</h3>
                <div class="value" id="monthCount">0</div>
            </div>
        </div>
        
        <div class="controls">
            <div>
                <button onclick="processEmails(false)" id="processBtn">üìß Process New Emails</button>
                <button onclick="processEmails(true)" id="processAllBtn" class="btn-orange">üîÑ Process All</button>
                <button onclick="scanAndExtract()" id="scanBtn" class="btn-green">üìÇ Scan & Extract Existing PDFs</button>
                <button onclick="retryExtraction()" id="retryBtn" class="btn-red">üîÑ Retry Extraction (Reprocess All)</button>
                <button onclick="openMainFolder()" class="btn-orange">üìÅ Open Folder</button>
                <button onclick="toggleAutoMonitor()" id="autoMonitorBtn" class="btn-green">üîî Start Auto-Monitor</button>
                <button onclick="toggleConfig()" class="btn-gray">‚öôÔ∏è Configure</button>
                <button onclick="refreshData()" class="btn-green">üîÑ Refresh Data</button>
            </div>
            
            <div id="progressBar" class="progress-bar">
                <div class="progress-container">
                    <div id="progressFill" class="progress-fill"></div>
                    <div id="progressText" class="progress-text">0%</div>
                </div>
            </div>
            
            <div id="configSection" class="config-section">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Important:</strong> Use Gmail App Password, not regular password!<br>
                    <small>Generate at: <a href="https://myaccount.google.com/apppasswords" target="_blank">myaccount.google.com/apppasswords</a></small>
                </div>
                <label>Email:</label>
                <input type="text" id="email" placeholder="your-email@gmail.com">
                <label>App Password:</label>
                <input type="password" id="password" placeholder="xxxx xxxx xxxx xxxx">
                <label>From Email:</label>
                <input type="text" id="fromEmail" placeholder="no-reply@mofa.gov.sa">
                <label>Subject Filter:</label>
                <input type="text" id="subjectFilter" placeholder="Saudi eVisa">
                <label>Save Path:</label>
                <input type="text" id="savePath" placeholder="\\COUNTER3\Shared Data\Visa_Slips_Automated">
                <label>Auto-Monitor Interval (seconds):</label>
                <input type="number" id="checkInterval" value="300" min="60">
                <button onclick="saveConfig()" style="margin-top: 10px;">üíæ Save Configuration</button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">üìä Overview</div>
            <div class="tab" onclick="switchTab('analytics')">üìà Analytics</div>
            <div class="tab" onclick="switchTab('records')">üìã All Records</div>
            <div class="tab" onclick="switchTab('recent')">üÜï Recent</div>
            <div class="tab" onclick="switchTab('employers')">üè¢ By Employer</div>
            <div class="tab" onclick="switchTab('dates')">üìÖ By Date</div>
        </div>

        <div id="overview" class="tab-content active">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìã Activity Log</h3>
                <div id="logContainer" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <!-- Charts Section -->
            <div class="chart-grid">
                <div class="chart-container">
                    <h3>üìä Visas by Nationality</h3>
                    <div class="chart-wrapper">
                        <canvas id="nationalityChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìà Visas Over Time</h3>
                    <div class="chart-wrapper">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üè¢ Top 10 Employers</h3>
                    <div class="chart-wrapper">
                        <canvas id="employerChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üíº Occupations Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="occupationChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìÖ Visa Types</h3>
                    <div class="chart-wrapper">
                        <canvas id="visaTypeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>‚è±Ô∏è Processing Duration</h3>
                    <div class="chart-wrapper">
                        <canvas id="durationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3>üìä Key Metrics</h3>
                    <div class="metric">
                        <span class="metric-label">Total Visas Processed</span>
                        <span class="metric-value" id="metricTotal">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Average per Day</span>
                        <span class="metric-value" id="metricAvgPerDay">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Most Active Day</span>
                        <span class="metric-value" id="metricMostActiveDay">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Most Common Visa Type</span>
                        <span class="metric-value" id="metricCommonVisaType">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Average Duration (days)</span>
                        <span class="metric-value" id="metricAvgDuration">0</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <h3>üèÜ Top 5 Nationalities</h3>
                    <ul class="top-list" id="topNationalities"></ul>
                </div>

                <div class="analysis-card">
                    <h3>üè¢ Top 5 Employers</h3>
                    <ul class="top-list" id="topEmployers"></ul>
                </div>

                <div class="analysis-card">
                    <h3>üíº Top 5 Occupations</h3>
                    <ul class="top-list" id="topOccupations"></ul>
                </div>

                <div class="analysis-card">
                    <h3>üìÖ Recent Trends (Last 30 Days)</h3>
                    <div class="metric">
                        <span class="metric-label">Visas This Month</span>
                        <span class="metric-value trend-up" id="trendThisMonth">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last 7 Days</span>
                        <span class="metric-value" id="trendLast7Days">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last 30 Days</span>
                        <span class="metric-value" id="trendLast30Days">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Growth Rate</span>
                        <span class="metric-value trend-up" id="trendGrowthRate">0%</span>
                    </div>
                </div>

                <div class="analysis-card">
                    <h3>üåç Geographic Distribution</h3>
                    <div class="metric">
                        <span class="metric-label">Total Countries</span>
                        <span class="metric-value" id="geoTotalCountries">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Most Common Region</span>
                        <span class="metric-value" id="geoMostCommonRegion">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Asian Countries</span>
                        <span class="metric-value" id="geoAsianCount">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Other Regions</span>
                        <span class="metric-value" id="geoOtherCount">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="records" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìã All Visa Records</h3>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by name, visa no, passport, employer..." onkeyup="searchRecords()">
                    <button onclick="exportToCSV()">üì• Export CSV</button>
                </div>
                <div class="table-wrapper">
                    <table id="recordsTable">
                        <thead>
                            <tr>
                                <th>Visa No</th>
                                <th>Application No</th>
                                <th>Name</th>
                                <th>Passport</th>
                                <th>Nationality</th>
                                <th>Visa Type</th>
                                <th>Valid From</th>
                                <th>Valid Until</th>
                                <th>Duration</th>
                                <th>Ref. No</th>
                                <th>Ref. Date</th>
                                <th>Occupation</th>
                                <th>Employer</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                            <tr><td colspan="15" class="no-data">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="paginationControls" style="display: none;">
                    <button onclick="changePage(1)" id="firstPage">‚èÆ First</button>
                    <button onclick="changePage(currentPage - 1)" id="prevPage">‚óÄ Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button onclick="changePage(currentPage + 1)" id="nextPage">Next ‚ñ∂</button>
                    <button onclick="changePage(totalPages)" id="lastPage">Last ‚è≠</button>
                    <select id="perPageSelect" onchange="changePerPage()" style="margin-left: 15px;">
                        <option value="25">25 per page</option>
                        <option value="50" selected>50 per page</option>
                        <option value="100">100 per page</option>
                        <option value="200">200 per page</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="recent" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üÜï Recent Records (Last 50)</h3>
                <div id="recentRecordsContainer"></div>
            </div>
        </div>

        <div id="employers" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üè¢ Records by Employer</h3>
                <div id="employersContainer"></div>
            </div>
        </div>

        <div id="dates" class="tab-content">
            <div class="section">
                <h3 style="margin-bottom: 15px;">üìÖ Records by Date</h3>
                <div id="datesContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let config = {};
        let allRecords = [];
        let currentPage = 1;
        let perPage = 50;
        let totalPages = 1;
        let totalRecords = 0;
        let autoMonitorInterval = null;
        
        // Load configuration
        async function loadConfig() {
            const response = await fetch('/api/config');
            config = await response.json();
            document.getElementById('email').value = config.email || '';
            document.getElementById('password').value = config.password || '';
            document.getElementById('fromEmail').value = config.from_email || '';
            document.getElementById('subjectFilter').value = config.subject_filter || '';
            document.getElementById('savePath').value = config.save_path || '';
            document.getElementById('checkInterval').value = config.check_interval || 300;
        }
        
        // Save configuration
        async function saveConfig() {
            const newConfig = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                from_email: document.getElementById('fromEmail').value,
                subject_filter: document.getElementById('subjectFilter').value,
                save_path: document.getElementById('savePath').value,
                check_interval: parseInt(document.getElementById('checkInterval').value)
            };
            
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newConfig)
            });
            
            if (response.ok) {
                showAlert('Configuration saved successfully!', 'success');
                config = newConfig;
            }
        }
        
        function toggleConfig() {
            const section = document.getElementById('configSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }
        
        // Process emails
        async function processEmails(includeDownloaded = false) {
            const btn = document.getElementById('processBtn');
            const btnAll = document.getElementById('processAllBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            btn.disabled = true;
            btnAll.disabled = true;
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Starting...';
            
            addLog('üöÄ Starting email processing...');
            
            await processStream('/api/process', {include_downloaded: includeDownloaded}, btn, btnAll, progressBar, progressFill, progressText);
        }
        
        // Scan and extract existing PDFs
        async function scanAndExtract() {
            const btn = document.getElementById('scanBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (!confirm('This will scan all folders and extract data from unprocessed PDFs. PDFs will be renamed with "_extracted" suffix. Continue?')) {
                return;
            }
            
            btn.disabled = true;
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Scanning...';
            
            addLog('üîç Starting folder scan and extraction...');
            
            await processStream('/api/scan-and-extract', {}, btn, null, progressBar, progressFill, progressText);
        }
        
        // Retry extraction on already processed PDFs
        async function retryExtraction() {
            const btn = document.getElementById('retryBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (!confirm('This will reprocess ALL previously extracted PDFs with improved OCR and update the database. This may take a while. Continue?')) {
                return;
            }
            
            btn.disabled = true;
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Scanning...';
            
            addLog('üîÑ Starting re-extraction with improved OCR...');
            
            await processStream('/api/retry-extraction', {}, btn, null, progressBar, progressFill, progressText);
        }
        
        // Generic stream processor
        async function processStream(url, body, btn1, btn2, progressBar, progressFill, progressText) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.type === 'progress') {
                                    const percent = (data.current / data.total * 100).toFixed(0);
                                    progressFill.style.width = percent + '%';
                                    progressText.textContent = `${data.current}/${data.total} (${percent}%)`;
                                } else if (data.type === 'info') {
                                    addLog(data.message, 'info');
                                } else if (data.type === 'success') {
                                    addLog(data.message, 'success');
                                } else if (data.type === 'warning') {
                                    addLog(data.message, 'warning');
                                } else if (data.type === 'error') {
                                    addLog(data.message, 'error');
                                } else if (data.type === 'summary') {
                                    const msg = data.total_scanned 
                                        ? `‚úÖ Processed: ${data.total_processed}/${data.total_scanned} PDFs`
                                        : `‚úÖ Total processed: ${data.total_processed} new records`;
                                    addLog(msg, 'success');
                                    if (data.total_processed > 0) {
                                        showAlert(`Successfully processed ${data.total_processed} records!`, 'success');
                                    }
                                } else if (data.type === 'complete') {
                                    addLog(data.message, 'success');
                                    progressFill.style.width = '100%';
                                    progressText.textContent = 'Complete!';
                                }
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }
                
                await refreshData();
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
            }
            
            btn1.disabled = false;
            if (btn2) btn2.disabled = false;
            setTimeout(() => {
                progressBar.style.display = 'none';
            }, 3000);
        }
        
        // Auto-monitor
        function toggleAutoMonitor() {
            const btn = document.getElementById('autoMonitorBtn');
            if (autoMonitorInterval) {
                clearInterval(autoMonitorInterval);
                autoMonitorInterval = null;
                btn.textContent = 'üîî Start Auto-Monitor';
                btn.className = 'btn-green';
                showAlert('Auto-monitor stopped', 'info');
            } else {
                const interval = (config.check_interval || 300) * 1000;
                autoMonitorInterval = setInterval(() => {
                    addLog('üîî Auto-monitor: Checking for new emails...', 'info');
                    processEmails(false);
                }, interval);
                btn.textContent = 'üîï Stop Auto-Monitor';
                btn.className = 'btn-orange';
                showAlert(`Auto-monitor started (checking every ${config.check_interval || 300} seconds)`, 'success');
            }
        }
        
        // Update statistics
        async function updateStats() {
            const response = await fetch('/api/stats');
            const stats = await response.json();
            document.getElementById('totalProcessed').textContent = stats.total_processed;
            document.getElementById('employerCount').textContent = Object.keys(stats.by_employer).length;
            document.getElementById('nationalityCount').textContent = Object.keys(stats.by_nationality).length;
            
            // Calculate this month
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            let monthCount = 0;
            for (const [date, count] of Object.entries(stats.by_date)) {
                if (date.startsWith(thisMonth)) {
                    monthCount += count;
                }
            }
            document.getElementById('monthCount').textContent = monthCount;
        }
        
        // Load all records with pagination
        async function loadRecords(page = 1, search = '') {
            currentPage = page;
            const searchQuery = search || document.getElementById('searchInput')?.value || '';
            const url = `/api/records?page=${page}&per_page=${perPage}${searchQuery ? '&search=' + encodeURIComponent(searchQuery) : ''}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            allRecords = data.records;
            totalPages = data.pagination.total_pages;
            totalRecords = data.pagination.total;
            
            displayRecords(allRecords);
            updatePaginationControls(data.pagination);
            
            // Load full dataset for other tabs (Recent, Employers, Dates)
            if (page === 1 && !search) {
                await loadFullDataForTabs();
            }
        }
        
        // Load full dataset for Recent, Employers, and Dates tabs
        async function loadFullDataForTabs() {
            const response = await fetch('/api/records?per_page=999999');
            const data = await response.json();
            const fullRecords = data.records;
            
            displayRecentRecords(fullRecords);
            displayEmployers(fullRecords);
            displayDates(fullRecords);
        }
        
        // Update pagination controls
        function updatePaginationControls(pagination) {
            const controls = document.getElementById('paginationControls');
            const pageInfo = document.getElementById('pageInfo');
            const firstBtn = document.getElementById('firstPage');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const lastBtn = document.getElementById('lastPage');
            
            if (pagination.total > perPage) {
                controls.style.display = 'flex';
                pageInfo.textContent = `Page ${pagination.page} of ${pagination.total_pages} (${pagination.total} records)`;
                
                firstBtn.disabled = !pagination.has_prev;
                prevBtn.disabled = !pagination.has_prev;
                nextBtn.disabled = !pagination.has_next;
                lastBtn.disabled = !pagination.has_next;
            } else {
                controls.style.display = 'none';
            }
        }
        
        // Change page
        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            loadRecords(page);
        }
        
        // Change records per page
        function changePerPage() {
            perPage = parseInt(document.getElementById('perPageSelect').value);
            loadRecords(1);
        }
        
        // Display records in table
        function displayRecords(records) {
            const tbody = document.getElementById('recordsBody');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="no-data">No records found</td></tr>';
                return;
            }
            
            tbody.innerHTML = records.map(r => `
                <tr>
                    <td>${r.visa_no || 'N/A'}</td>
                    <td>${r.application_no || 'N/A'}</td>
                    <td>${r.name || 'N/A'}</td>
                    <td>${r.passport_no || 'N/A'}</td>
                    <td>${r.nationality || 'N/A'}</td>
                    <td>${r.visa_type || 'N/A'}</td>
                    <td>${r.valid_from || 'N/A'}</td>
                    <td>${r.valid_until || 'N/A'}</td>
                    <td>${r.duration_of_stay || 'N/A'}</td>
                    <td>${r.ref_no || 'N/A'}</td>
                    <td>${r.ref_date || 'N/A'}</td>
                    <td>${r.occupation || 'N/A'}</td>
                    <td>${r.employer_name || 'N/A'}</td>
                    <td>${r.processed_date || 'N/A'}</td>
                    <td>
                        <button class="btn-small btn-orange" onclick="openRecordFolder('${r.processed_date}', '${r.pdf_filename}')">üìÅ</button>
                        <button class="btn-small btn-green" onclick="openRecordFile('${r.processed_date}', '${r.pdf_filename}', 'xlsx')">üìä</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Search records - now uses server-side search with pagination
        function searchRecords() {
            const query = document.getElementById('searchInput').value;
            // Reset to page 1 when searching
            loadRecords(1, query);
        }
        
        // Display recent records
        function displayRecentRecords(fullRecords) {
            const container = document.getElementById('recentRecordsContainer');
            const recent = fullRecords.slice(0, 50);
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="no-data">No records yet</div>';
                return;
            }
            
            container.innerHTML = recent.map(r => `
                <div style="background: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid #4CAF50;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #2196F3; font-size: 16px;">${r.name || 'N/A'}</strong>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                Visa: ${r.visa_no || 'N/A'} | Passport: ${r.passport_no || 'N/A'} | ${r.nationality || 'N/A'}
                            </div>
                            <div style="font-size: 13px; color: #666;">
                                Employer: ${r.employer_name || 'N/A'}
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 3px;">
                                Valid: ${r.valid_from || 'N/A'} to ${r.valid_until || 'N/A'} | Processed: ${r.processed_date || 'N/A'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn-small btn-orange" onclick="openRecordFolder('${r.processed_date}', '${r.pdf_filename}')">üìÅ Folder</button>
                            <button class="btn-small" onclick="openRecordFile('${r.processed_date}', '${r.pdf_filename}', 'pdf')">üìÑ PDF</button>
                            <button class="btn-small btn-green" onclick="openRecordFile('${r.processed_date}', '${r.pdf_filename}', 'xlsx')">üìä Excel</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Display employers
        function displayEmployers(fullRecords) {
            const container = document.getElementById('employersContainer');
            const employers = {};
            
            fullRecords.forEach(r => {
                const emp = r.employer_name || 'Unknown';
                if (!employers[emp]) {
                    employers[emp] = [];
                }
                employers[emp].push(r);
            });
            
            const sorted = Object.entries(employers).sort((a, b) => b[1].length - a[1].length);
            
            container.innerHTML = sorted.map(([emp, records]) => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 16px;">${emp}</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                ${records.length} visa(s)
                            </div>
                        </div>
                        <button class="btn-small" onclick="filterByEmployer('${emp}')">View Records</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Display dates
        function displayDates(fullRecords) {
            const container = document.getElementById('datesContainer');
            const dates = {};
            
            fullRecords.forEach(r => {
                const date = r.processed_date || 'Unknown';
                if (!dates[date]) {
                    dates[date] = [];
                }
                dates[date].push(r);
            });
            
            const sorted = Object.entries(dates).sort((a, b) => b[0].localeCompare(a[0]));
            
            container.innerHTML = sorted.map(([date, records]) => `
                <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 16px;">üìÖ ${date}</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                ${records.length} visa(s)
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-small btn-orange" onclick="openDateFolder('${date}')">üìÅ Open Folder</button>
                            <button class="btn-small" onclick="filterByDate('${date}')">View Records</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Filter functions
        function filterByEmployer(employer) {
            switchTab('records');
            document.getElementById('searchInput').value = employer;
            searchRecords();
        }
        
        async function filterByDate(date) {
            switchTab('records');
            // Load records for specific date
            const response = await fetch(`/api/records?per_page=999999&search=${encodeURIComponent(date)}`);
            const data = await response.json();
            allRecords = data.records;
            displayRecords(allRecords);
            // Hide pagination when filtering
            document.getElementById('paginationControls').style.display = 'none';
        }
        
        // Open folder/file functions
        async function openMainFolder() {
            await openFolder(config.save_path);
        }
        
        async function openDateFolder(date) {
            const path = `${config.save_path}\\\\${date}`;
            await openFolder(path);
        }
        
        async function openRecordFolder(date, filename) {
            const path = `${config.save_path}\\\\${date}`;
            await openFolder(path);
        }
        
        async function openRecordFile(date, filename, ext) {
            const newFilename = filename.replace('.pdf', `.${ext}`);
            const path = `${config.save_path}\\\\${date}\\\\${newFilename}`;
            await openFolder(path);
        }
        
        async function openFolder(path) {
            try {
                const response = await fetch('/api/open-folder', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path: path})
                });
                const data = await response.json();
                if (!data.success) {
                    showAlert('Could not open: ' + data.error, 'warning');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        // Export to CSV - exports all records, not just current page
        async function exportToCSV() {
            // Fetch all records without pagination
            const response = await fetch('/api/records?per_page=999999');
            const data = await response.json();
            const allRecordsForExport = data.records;
            
            const headers = ['Visa No', 'Application No', 'Name', 'Passport', 'Nationality', 'Visa Type', 'Valid From', 'Valid Until', 'Duration', 'Ref. No', 'Ref. Date', 'Occupation', 'Employer', 'Date'];
            const rows = allRecordsForExport.map(r => [
                r.visa_no, r.application_no, r.name, r.passport_no, r.nationality, r.visa_type,
                r.valid_from, r.valid_until, r.duration_of_stay, r.ref_no, r.ref_date,
                r.occupation, r.employer_name, r.processed_date
            ]);
            
            let csv = headers.join(',') + '\\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell || ''}"`).join(',') + '\\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `visa_records_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showAlert(`Exported ${allRecordsForExport.length} records to CSV`, 'success');
        }
        
        // Refresh all data
        async function refreshData() {
            await updateStats();
            await loadRecords();
            showAlert('Data refreshed!', 'info');
        }
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.toLowerCase().includes(tabName.toLowerCase()) || 
                    tab.getAttribute('onclick')?.includes(tabName)) {
                    tab.classList.add('active');
                }
            });
            
            document.getElementById(tabName).classList.add('active');
        }
        
        // Logging
        function addLog(message, type = 'info') {
            const log = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.style.padding = '8px';
            entry.style.borderBottom = '1px solid #eee';
            entry.style.fontSize = '14px';
            entry.style.color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#FF9800' : '#2196F3';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.insertBefore(entry, log.firstChild);
            
            while (log.children.length > 100) {
                log.removeChild(log.lastChild);
            }
        }
        
        // Show alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Initialize
        loadConfig();
        updateStats();
        loadRecords();
        setInterval(updateStats, 30000);
        
        // Check for new emails every 5 minutes if auto-monitor is enabled
        setInterval(() => {
            if (autoMonitorInterval) {
                addLog('üîî Checking for new emails...', 'info');
            }
        }, 300000);
        
        // Charts and Analytics
        let charts = {};
        
        // Initialize all charts
        async function initializeCharts() {
            // Fetch all records for analysis
            const response = await fetch('/api/records?per_page=999999');
            const data = await response.json();
            const allRecords = data.records;
            
            if (allRecords.length === 0) {
                return;
            }
            
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Create charts
            createNationalityChart(allRecords);
            createTimelineChart(allRecords);
            createEmployerChart(allRecords);
            createOccupationChart(allRecords);
            createVisaTypeChart(allRecords);
            createDurationChart(allRecords);
            
            // Update analytics
            updateAnalytics(allRecords);
        }
        
        // Nationality Chart (Pie)
        function createNationalityChart(records) {
            const nationalityCounts = {};
            records.forEach(r => {
                const nat = r.nationality || 'Unknown';
                nationalityCounts[nat] = (nationalityCounts[nat] || 0) + 1;
            });
            
            const sorted = Object.entries(nationalityCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('nationalityChart');
            charts.nationality = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(([nat]) => nat),
                    datasets: [{
                        data: sorted.map(([, count]) => count),
                        backgroundColor: [
                            '#2196F3', '#4CAF50', '#FF9800', '#F44336', '#9C27B0',
                            '#00BCD4', '#FFEB3B', '#795548', '#607D8B', '#E91E63'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Timeline Chart (Line)
        function createTimelineChart(records) {
            const dateCounts = {};
            records.forEach(r => {
                const date = r.processed_date || 'Unknown';
                dateCounts[date] = (dateCounts[date] || 0) + 1;
            });
            
            const sorted = Object.entries(dateCounts).sort((a, b) => a[0].localeCompare(b[0]));
            
            const ctx = document.getElementById('timelineChart');
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(([date]) => date),
                    datasets: [{
                        label: 'Visas Processed',
                        data: sorted.map(([, count]) => count),
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        // Employer Chart (Bar)
        function createEmployerChart(records) {
            const employerCounts = {};
            records.forEach(r => {
                const emp = r.employer_name || 'Unknown';
                employerCounts[emp] = (employerCounts[emp] || 0) + 1;
            });
            
            const sorted = Object.entries(employerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('employerChart');
            charts.employer = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([emp]) => emp.length > 30 ? emp.substring(0, 30) + '...' : emp),
                    datasets: [{
                        label: 'Visas',
                        data: sorted.map(([, count]) => count),
                        backgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        // Occupation Chart (Pie)
        function createOccupationChart(records) {
            const occupationCounts = {};
            records.forEach(r => {
                let occ = r.occupation || 'Unknown';
                // Extract English part if bilingual
                if (occ.includes(' - ')) {
                    occ = occ.split(' - ')[0];
                }
                occupationCounts[occ] = (occupationCounts[occ] || 0) + 1;
            });
            
            const sorted = Object.entries(occupationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const ctx = document.getElementById('occupationChart');
            charts.occupation = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sorted.map(([occ]) => occ),
                    datasets: [{
                        data: sorted.map(([, count]) => count),
                        backgroundColor: [
                            '#FF9800', '#2196F3', '#4CAF50', '#F44336',
                            '#9C27B0', '#00BCD4', '#FFEB3B', '#795548'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }
        
        // Visa Type Chart (Doughnut)
        function createVisaTypeChart(records) {
            const typeCounts = {};
            records.forEach(r => {
                const type = r.visa_type || 'Unknown';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            
            const sorted = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
            
            const ctx = document.getElementById('visaTypeChart');
            charts.visaType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(([type]) => type),
                    datasets: [{
                        data: sorted.map(([, count]) => count),
                        backgroundColor: ['#2196F3', '#4CAF50', '#FF9800', '#F44336', '#9C27B0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // Duration Chart (Bar)
        function createDurationChart(records) {
            const durationCounts = {};
            records.forEach(r => {
                const dur = r.duration_of_stay || 'Unknown';
                durationCounts[dur] = (durationCounts[dur] || 0) + 1;
            });
            
            const sorted = Object.entries(durationCounts).sort((a, b) => {
                const aNum = parseInt(a[0]) || 0;
                const bNum = parseInt(b[0]) || 0;
                return aNum - bNum;
            });
            
            const ctx = document.getElementById('durationChart');
            charts.duration = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([dur]) => dur + ' days'),
                    datasets: [{
                        label: 'Count',
                        data: sorted.map(([, count]) => count),
                        backgroundColor: '#9C27B0'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        // Update Analytics
        function updateAnalytics(records) {
            // Key Metrics
            document.getElementById('metricTotal').textContent = records.length;
            
            // Average per day
            const dates = [...new Set(records.map(r => r.processed_date))];
            const avgPerDay = (records.length / dates.length).toFixed(1);
            document.getElementById('metricAvgPerDay').textContent = avgPerDay;
            
            // Most active day
            const dateCounts = {};
            records.forEach(r => {
                const date = r.processed_date || 'Unknown';
                dateCounts[date] = (dateCounts[date] || 0) + 1;
            });
            const mostActiveDay = Object.entries(dateCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('metricMostActiveDay').textContent = 
                mostActiveDay ? `${mostActiveDay[0]} (${mostActiveDay[1]})` : '-';
            
            // Most common visa type
            const typeCounts = {};
            records.forEach(r => {
                const type = r.visa_type || 'Unknown';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            const mostCommonType = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('metricCommonVisaType').textContent = 
                mostCommonType ? mostCommonType[0] : '-';
            
            // Average duration
            const durations = records
                .map(r => parseInt(r.duration_of_stay))
                .filter(d => !isNaN(d));
            const avgDuration = durations.length > 0 
                ? (durations.reduce((a, b) => a + b, 0) / durations.length).toFixed(0)
                : 0;
            document.getElementById('metricAvgDuration').textContent = avgDuration;
            
            // Top Nationalities
            const nationalityCounts = {};
            records.forEach(r => {
                const nat = r.nationality || 'Unknown';
                nationalityCounts[nat] = (nationalityCounts[nat] || 0) + 1;
            });
            const topNats = Object.entries(nationalityCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            document.getElementById('topNationalities').innerHTML = topNats.map(([nat, count], idx) => `
                <li>
                    <span class="rank">${idx + 1}</span>
                    <span class="name">${nat}</span>
                    <span class="count">${count}</span>
                </li>
            `).join('');
            
            // Top Employers
            const employerCounts = {};
            records.forEach(r => {
                const emp = r.employer_name || 'Unknown';
                employerCounts[emp] = (employerCounts[emp] || 0) + 1;
            });
            const topEmps = Object.entries(employerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            document.getElementById('topEmployers').innerHTML = topEmps.map(([emp, count], idx) => `
                <li>
                    <span class="rank">${idx + 1}</span>
                    <span class="name">${emp.length > 40 ? emp.substring(0, 40) + '...' : emp}</span>
                    <span class="count">${count}</span>
                </li>
            `).join('');
            
            // Top Occupations
            const occupationCounts = {};
            records.forEach(r => {
                let occ = r.occupation || 'Unknown';
                if (occ.includes(' - ')) {
                    occ = occ.split(' - ')[0];
                }
                occupationCounts[occ] = (occupationCounts[occ] || 0) + 1;
            });
            const topOccs = Object.entries(occupationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            document.getElementById('topOccupations').innerHTML = topOccs.map(([occ, count], idx) => `
                <li>
                    <span class="rank">${idx + 1}</span>
                    <span class="name">${occ}</span>
                    <span class="count">${count}</span>
                </li>
            `).join('');
            
            // Recent Trends
            const now = new Date();
            const last7Days = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            const last7Count = records.filter(r => new Date(r.processed_date) >= last7Days).length;
            const last30Count = records.filter(r => new Date(r.processed_date) >= last30Days).length;
            const thisMonthCount = records.filter(r => r.processed_date && r.processed_date.startsWith(thisMonth)).length;
            
            document.getElementById('trendLast7Days').textContent = last7Count;
            document.getElementById('trendLast30Days').textContent = last30Count;
            document.getElementById('trendThisMonth').textContent = thisMonthCount;
            
            // Growth rate (comparing last 30 days to previous 30 days)
            const prev30Days = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);
            const prev30Count = records.filter(r => {
                const date = new Date(r.processed_date);
                return date >= prev30Days && date < last30Days;
            }).length;
            const growthRate = prev30Count > 0 
                ? (((last30Count - prev30Count) / prev30Count) * 100).toFixed(1)
                : 0;
            document.getElementById('trendGrowthRate').textContent = growthRate + '%';
            document.getElementById('trendGrowthRate').className = 
                'metric-value ' + (growthRate >= 0 ? 'trend-up' : 'trend-down');
            
            // Geographic Distribution
            const countries = new Set(records.map(r => r.nationality).filter(n => n));
            document.getElementById('geoTotalCountries').textContent = countries.size;
            
            // Asian countries (common ones)
            const asianCountries = ['Pakistan', 'India', 'Bangladesh', 'Philippines', 'Indonesia', 
                                   'Nepal', 'Sri Lanka', 'China', 'Thailand', 'Vietnam'];
            const asianCount = records.filter(r => 
                asianCountries.includes(r.nationality)
            ).length;
            document.getElementById('geoAsianCount').textContent = asianCount;
            document.getElementById('geoOtherCount').textContent = records.length - asianCount;
            
            const mostCommonNat = topNats[0];
            document.getElementById('geoMostCommonRegion').textContent = 
                mostCommonNat ? `${mostCommonNat[0]} (${mostCommonNat[1]})` : '-';
        }
        
        // Load charts when switching to analytics tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'analytics' && Object.keys(charts).length === 0) {
                initializeCharts();
            }
        };
    </script>
    
    <footer>
        <div class="footer-content">
            <div class="footer-title">
                <i class="bi bi-info-circle"></i>
                Saudi eVisa Automation Dashboard ¬© 2024
            </div>
            <div class="footer-divider"></div>
            <div class="footer-info">
                <i class="bi bi-code-slash"></i> Developed by: <strong>Muhammad Siddique | SCT</strong>
            </div>
            <div class="footer-icons">
                <div class="footer-icon-item">
                    <i class="bi bi-telephone"></i>
                    <span>+92 331 5868 725</span>
                </div>
                <div class="footer-icon-item">
                    <i class="bi bi-envelope"></i>
                    <a href="mailto:siddique.dea@gmail.com">siddique.dea@gmail.com</a>
                </div>
                <div class="footer-icon-item">
                    <i class="bi bi-github"></i>
                    <a href="https://github.com/SiddiqueDataEng" target="_blank">GitHub Profile</a>
                </div>
                <div class="footer-icon-item">
                    <i class="bi bi-linkedin"></i>
                    <a href="https://www.linkedin.com/in/siddique-datalover/" target="_blank">LinkedIn Profile</a>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
